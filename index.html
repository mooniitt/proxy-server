<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Mock Dashboard (Vue 3)</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¡</text></svg>">
    <script src="/vue.global.js"></script>
    <style>
        :root {
            --primary-bg: #f8fafc;
            --sidebar-bg: #ffffff;
            --blue-light: #e0f2fe;
            --blue-main: #0ea5e9;
            --blue-dark: #0369a1;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", -apple-system, system-ui, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        body.resizing {
            user-select: none;
            cursor: col-resize;
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: #ffffff;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        header h1 {
            font-size: 1.1rem;
            color: var(--blue-dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: 2rem;
            flex: 1;
        }

        .info-pill {
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Tabs */
        .sidebar {
            /* width bound via :style in HTML */
            min-width: 250px;
            max-width: 600px;
            flex-shrink: 0;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .resizer {
            width: 8px;
            /* Wider hit area */
            cursor: col-resize;
            background-color: transparent;
            transition: background-color 0.2s;
            position: absolute;
            right: -4px;
            top: 0;
            bottom: 0;
            z-index: 10;
        }

        .resizer:hover,
        .resizer.active {
            background-color: var(--blue-main);
        }

        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
            position: relative;
        }

        .tab-btn.active {
            color: var(--blue-main);
        }

        .tab-btn.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--blue-main);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        /* Rule List Item */
        .list-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:hover {
            background-color: #f1f5f9;
        }

        .list-item.active {
            background-color: var(--blue-light);
            box-shadow: inset 4px 0 0 var(--blue-main);
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-sub {
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Traffic Specific */
        .status-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .status-2xx {
            background: #dcfce7;
            color: #166534;
        }

        .status-4xx,
        .status-5xx {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-mock {
            border: 1px solid var(--blue-main);
            color: var(--blue-main);
        }

        /* Editor Area */
        .editor-container {
            flex: 1;
            background: white;
            overflow-y: auto;
            padding: 2rem;
        }

        .editor-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 700;
            border-left: 4px solid var(--blue-main);
            padding-left: 0.75rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input,
        select,
        textarea {
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.85rem;
            outline: none;
        }

        input:focusRow,
        textarea:focus {
            border-color: var(--blue-main);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        textarea {
            font-family: 'Fira Code', monospace;
            min-height: 250px;
            resize: vertical;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 18px;
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--blue-main);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary {
            background: var(--blue-main);
            color: white;
        }

        .btn-primary:active {
            background: var(--blue-dark);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1e293b;
            color: white;
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            font-size: 0.85rem;
            transform: translateY(100px);
            transition: 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
        }

        .empty-view {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            gap: 1rem;
            opacity: 0.6;
        }

        .badge-traffic {
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .modal-body h3 {
            margin: 1.5rem 0 0.5rem 0;
            color: var(--blue-dark);
            font-size: 1rem;
        }

        .modal-body p,
        .modal-body li {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        .modal-body ul {
            padding-left: 1.25rem;
        }

        .step-badge {
            background: var(--blue-light);
            color: var(--blue-dark);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 6px;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="toast" :class="{ show: toast.visible }" :style="{ background: toast.bg }">{{ toast.msg }}</div>

        <header>
            <h1><span>âš¡</span> Proxy Mock</h1>
            <div class="header-info">
                <div v-if="serverInfo.ip" class="info-pill">
                    ä»£ç†åœ°å€ï¼š<strong>{{ serverInfo.ip }}:{{ serverInfo.port }}</strong>
                </div>
            </div>
            <div style="display: flex; gap: 0.8rem;">
                <button class="btn btn-secondary" @click="showHelp = true">ğŸ’¡ ä½¿ç”¨è¯´æ˜</button>
                <button class="btn btn-secondary" @click="regenerateCA">ğŸ”„ é‡ç”Ÿæˆ CA</button>
                <a href="/ca.crt" class="btn btn-secondary" style="text-decoration: none;">ğŸ“¥ ä¸‹è½½ CA è¯ä¹¦</a>
                <button class="btn btn-secondary" @click="exportConfig">å¯¼å‡ºé…ç½®</button>
                <button class="btn btn-primary" @click="saveAll">å…¨éƒ¨ä¿å­˜</button>
            </div>
        </header>

        <div class="main-container">
            <!-- Sidebar -->
            <div class="sidebar" :style="{ width: sidebarWidth + 'px' }">
                <div class="resizer" @mousedown="startResizing"></div>
                <div class="tab-header">
                    <button class="tab-btn" :class="{ active: activeTab === 'rules' }"
                        @click="activeTab = 'rules'">è§„åˆ™é…ç½®</button>
                    <button class="tab-btn" :class="{ active: activeTab === 'traffic' }"
                        @click="activeTab = 'traffic'">æµé‡ç›‘æ§</button>
                </div>

                <!-- Rules Tab -->
                <div v-if="activeTab === 'rules'" class="sidebar-content">
                    <div
                        style="padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 0.5rem;">
                        <input type="text" v-model="ruleSearch" placeholder="æœç´¢è§„åˆ™..."
                            style="flex: 1; font-size: 0.8rem;">
                        <button class="btn btn-primary" style="padding: 0.4rem 0.8rem;" @click="addRule">+ æ–°å¢</button>
                    </div>
                    <div v-for="rule in filteredRules" :key="rule.id" class="list-item"
                        :class="{ active: currentRule?.id === rule.id }" @click="selectRule(rule)">
                        <div class="item-info">
                            <div class="item-title">{{ rule.name }}</div>
                            <div class="item-sub">{{ rule.url }}</div>
                        </div>
                        <label class="switch" @click.stop>
                            <input type="checkbox" v-model="rule.enabled" @change="saveAll">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div v-if="filteredRules.length === 0"
                        style="padding: 2rem; text-align: center; color: #94a3b8; font-size: 0.8rem;">æš‚æ— åŒ¹é…è§„åˆ™</div>
                </div>

                <!-- Traffic Tab -->
                <div v-if="activeTab === 'traffic'" class="sidebar-content">
                    <div
                        style="padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.75rem; font-weight: 700; color: var(--text-secondary);">å®æ—¶æµé‡ (æœ€è¿‘
                                100
                                æ¡)</span>
                            <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;"
                                @click.stop="getTraffic(true)">åˆ·æ–°</button>
                        </div>
                        <input type="text" v-model="trafficSearch" placeholder="æœç´¢æµé‡ (æ–¹æ³•, URL)..."
                            style="font-size: 0.8rem; width: 100%;">
                    </div>
                    <div v-for="log in filteredTraffic" :key="log.id" class="list-item" @click="selectTraffic(log)">
                        <div class="item-info">
                            <div class="item-title" style="display:flex; align-items:center; gap: 4px;">
                                <span class="badge-traffic"
                                    :style="{ color: log.method === 'POST' ? '#f59e0b' : '#0ea5e9' }">{{ log.method
                                    }}</span>
                                <span class="status-badge"
                                    :class="log.statusCode >= 400 ? 'status-4xx' : 'status-2xx'">{{ log.statusCode
                                    }}</span>
                                <span v-if="log.mocked" class="status-badge status-mock">MOCK</span>
                            </div>
                            <div class="item-sub">{{ log.url }}</div>
                        </div>
                        <div style="font-size:0.6rem; color:#94a3b8; text-align: right;">
                            <div>{{ formatTime(log.time) }}</div>
                            <!-- <div style="font-size: 0.55rem">{{ log.duration }}</div> -->
                        </div>
                    </div>
                    <div v-if="traffic.length === 0"
                        style="padding: 2rem; text-align: center; color: #94a3b8; font-size: 0.8rem;">ç­‰å¾…è¯·æ±‚è¿›å…¥...</div>
                </div>
            </div>

            <!-- Editor -->
            <div class="editor-container">
                <!-- Rule Editor -->
                <div v-if="editorMode === 'rule' && currentRule" class="editor-content">
                    <section>
                        <div class="section-title">åŸºç¡€é…ç½®</div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>è§„åˆ™åç§°</label>
                                <input type="text" v-model="currentRule.name">
                            </div>
                            <div class="form-group">
                                <label>æ¿€æ´»çŠ¶æ€</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem; height: 100%;">
                                    <label class="switch">
                                        <input type="checkbox" v-model="currentRule.enabled">
                                        <span class="slider"></span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: var(--text-secondary)">{{ currentRule.enabled
                                        ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨' }}</span>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="section-title">åŒ¹é…é€»è¾‘</div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>åŒ¹é…æ–¹å¼</label>
                                <select v-model="currentRule.matchType">
                                    <option value="regex">æ­£åˆ™åŒ¹é… (Regex)</option>
                                    <option value="exact">ç²¾ç¡®åŒ¹é… (Exact)</option>
                                    <option value="prefix">å‰ç¼€åŒ¹é… (Prefix)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>URL (æ”¯æŒ http/https)</label>
                                <input type="text" v-model="currentRule.url" placeholder="ä¾‹å¦‚: http://api.com/user">
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="section-title">å“åº” Mock</div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>çŠ¶æ€ç </label>
                                <input type="number" v-model.number="currentRule.response.statusCode">
                            </div>
                            <div class="form-group">
                                <label>Content-Type</label>
                                <input type="text" v-model="currentRule.response.headers['Content-Type']"
                                    placeholder="application/json">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label>å“åº”ä½“ (Body)</label>
                            <textarea v-model="currentRule.response.body"
                                placeholder="æ”¯æŒ JSON, HTML, æ–‡æœ¬ç­‰..."></textarea>
                        </div>
                    </section>
                    <div
                        style="display:flex; justify-content:space-between; margin-top:2rem; padding: 1rem 0; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-danger" @click="deleteRule(currentRule.id)">åˆ é™¤æ­¤è§„åˆ™</button>
                        <button class="btn btn-primary" @click="saveAll">ä¿å­˜å…¨éƒ¨é…ç½®</button>
                    </div>
                </div>

                <!-- Traffic Detail -->
                <div v-else-if="editorMode === 'traffic' && selectedLog" class="editor-content">
                    <div class="section-title">è¯·æ±‚è¯¦æƒ…</div>
                    <div
                        style="background:#f1f5f9; padding:1.5rem; border-radius:8px; font-family:monospace; font-size:0.85rem; line-height:1.8;">
                        <div style="word-break: break-all;"><b>URL:</b> <span style="color: var(--blue-dark)">{{
                                selectedLog.url }}</span></div>
                        <div class="grid-2" style="margin-top: 1rem;">
                            <div><b>æ–¹æ³•:</b> {{ selectedLog.method }}</div>
                            <div><b>çŠ¶æ€ç :</b> <span
                                    :style="{ color: selectedLog.statusCode >= 400 ? 'red' : 'green' }">{{
                                    selectedLog.statusCode }}</span></div>
                            <div><b>æ—¶é—´:</b> {{ new Date(selectedLog.time).toLocaleString() }}</div>
                            <div><b>å“åº”è€—æ—¶:</b> {{ selectedLog.duration }}</div>
                        </div>
                        <div style="margin-top:1rem; border-top:1px solid #cbd5e1; padding-top:1rem;">
                            <div><b>å¤„ç†ç±»å‹:</b> {{ selectedLog.mocked ? 'MOCK å“åº”' : 'ç½‘ç»œé€ä¼ ' }}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" @click="createRuleFromTraffic(selectedLog)">âš¡ åŸºäºæ­¤è¯·æ±‚åˆ›å»º Mock
                            è§„åˆ™</button>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-else class="empty-view">
                    <svg width="60" height="60" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        style="opacity: 0.3;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>é€‰æ‹©å·¦ä¾§é¡¹ç›®æˆ–æŸ¥çœ‹æµé‡å®æ—¶åŠ¨æ€</p>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div v-if="showHelp" class="modal-overlay" @click.self="showHelp = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="font-size: 1.25rem;">âš¡ Proxy Mock ä½¿ç”¨è¯´æ˜</h2>
                    <button class="btn btn-secondary" @click="showHelp = false">å…³é—­</button>
                </div>
                <div class="modal-body">
                    <h3>1. è®¾ç½®ä»£ç†</h3>
                    <p>å°†æ‚¨çš„è®¾å¤‡ï¼ˆæ‰‹æœº/æµè§ˆå™¨ï¼‰ä»£ç†è®¾ç½®ä¸ºå½“å‰æœºå™¨ IPï¼Œç«¯å£ä¸º <code
                            style="background:#f1f5f9;padding:2px 4px;border-radius:3px;font-weight:bold;">9292</code>ã€‚
                    </p>

                    <h3>2. HTTPS è¯ä¹¦ä¿¡ä»» (å…³é”®)</h3>
                    <p>è‹¥è¦è§£å¯† HTTPS æµé‡ï¼Œè¯·ä¸‹è½½å¹¶ä¿¡ä»»è¯ä¹¦ï¼š</p>
                    <ul>
                        <li><span class="step-badge">iOS</span> ä¸‹è½½åï¼Œåœ¨â€œå…³äºæœ¬æœºâ€->â€œè¯ä¹¦ä¿¡ä»»è®¾ç½®â€ä¸­å‹¾é€‰ã€‚</li>
                        <li><span class="step-badge">Android</span> åœ¨â€œåŠ å¯†å’Œå‡­æ®â€ä¸­ä»å­˜å‚¨ç›˜å®‰è£…ã€‚</li>
                        <li><span class="step-badge">PC</span> å¯¼å…¥è‡³â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€ã€‚</li>
                    </ul>

                    <h3>3. åŒ¹é…æ¨¡å¼</h3>
                    <ul>
                        <li><strong>æ­£åˆ™åŒ¹é…</strong>: å»ºè®®ç”¨äºå¤æ‚ API è¿‡æ»¤ã€‚</li>
                        <li><strong>ç²¾ç¡®åŒ¹é…</strong>: URL å¿…é¡»å®Œå…¨ä¸€è‡´ã€‚</li>
                        <li><strong>å‰ç¼€åŒ¹é…</strong>: åŒ¹é…ä»¥ç‰¹å®šè·¯å¾„å¼€å¤´çš„è¯·æ±‚ã€‚</li>
                    </ul>

                    <div style="margin-top: 2rem; padding: 1rem; background: var(--blue-light); border-radius: 8px;">
                        <p style="margin:0; font-weight: 500; font-size: 0.85rem;">ğŸ’¡ æç¤ºï¼šæ‰€æœ‰è§„åˆ™æ”¹åŠ¨ç‚¹å‡»â€œå…¨éƒ¨ä¿å­˜â€åå³æ—¶ç”Ÿæ•ˆã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                const config = ref({ rules: [] });
                const traffic = ref([]);
                const activeTab = ref('rules');
                const ruleSearch = ref('');
                const trafficSearch = ref('');
                const currentRule = ref(null);
                const selectedLog = ref(null);
                const editorMode = ref('none'); // 'rule', 'traffic', 'none'
                const showHelp = ref(false);
                const sidebarWidth = ref(380);
                const isResizing = ref(false);
                const serverInfo = ref({ ip: '', port: '' });

                const startResizing = (e) => {
                    isResizing.value = true;
                    document.addEventListener('mousemove', doResize);
                    document.addEventListener('mouseup', stopResizing);
                    document.body.classList.add('resizing');
                };

                const doResize = (e) => {
                    if (!isResizing.value) return;
                    // Limit width between 250 and 600
                    const newWidth = Math.max(250, Math.min(600, e.clientX));
                    sidebarWidth.value = newWidth;
                };

                const stopResizing = () => {
                    isResizing.value = false;
                    document.removeEventListener('mousemove', doResize);
                    document.removeEventListener('mouseup', stopResizing);
                    document.body.classList.remove('resizing');
                };

                const toast = ref({ visible: false, msg: '', bg: '#10b981' });

                const filteredRules = computed(() => {
                    const s = ruleSearch.value.toLowerCase();
                    return config.value.rules.filter(r =>
                        r.name.toLowerCase().includes(s) ||
                        r.url.toLowerCase().includes(s)
                    );
                });

                const filteredTraffic = computed(() => {
                    const s = trafficSearch.value.toLowerCase();
                    if (!s) return traffic.value;
                    return traffic.value.filter(log =>
                        log.method.toLowerCase().includes(s) ||
                        log.url.toLowerCase().includes(s) ||
                        String(log.statusCode).includes(s)
                    );
                });

                const showToast = (msg, type = 'success') => {
                    toast.value.msg = msg;
                    toast.value.bg = type === 'success' ? '#10b981' : '#ef4444';
                    toast.value.visible = true;
                    setTimeout(() => toast.value.visible = false, 2000);
                };

                const getConfig = async () => {
                    try {
                        const res = await fetch('/api/config');
                        config.value = await res.json();

                        // Get Server Info
                        const infoRes = await fetch('/api/info');
                        if (infoRes.ok) serverInfo.value = await infoRes.json();
                        const savedRuleId = localStorage.getItem('selectedRuleId');
                        if (savedRuleId) {
                            const rule = config.value.rules.find(r => r.id === savedRuleId);
                            if (rule) selectRule(rule);
                        }
                    } catch (e) { showToast('åŠ è½½é…ç½®å¤±è´¥', 'error'); }
                };

                // Persistence logic
                watch(currentRule, (newRule) => {
                    if (newRule && newRule.id) {
                        localStorage.setItem('selectedRuleId', newRule.id);
                    } else {
                        localStorage.removeItem('selectedRuleId');
                    }
                });

                watch(sidebarWidth, (newWidth) => {
                    localStorage.setItem('sidebarWidth', newWidth);
                });

                const getTraffic = async (showMessage = false, silent = false) => {
                    try {
                        const url = silent ? '/api/traffic?silent=true' : '/api/traffic';
                        const res = await fetch(url);
                        if (!res.ok) {
                            console.error('Failed to fetch traffic:', res.status, res.statusText);
                            if (showMessage) {
                                showToast('è·å–æµé‡æ•°æ®å¤±è´¥', 'error');
                            }
                            return;
                        }
                        const data = await res.json();
                        traffic.value = data || [];
                        if (showMessage && traffic.value.length > 0) {
                            showToast(`å·²åŠ è½½ ${traffic.value.length} æ¡æµé‡è®°å½•`, 'success');
                        }
                    } catch (e) {
                        console.error('Error fetching traffic:', e);
                        if (showMessage) {
                            showToast('è·å–æµé‡æ•°æ®å¤±è´¥', 'error');
                        }
                    }
                };

                const saveAll = async () => {
                    try {
                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config.value)
                        });
                        if (res.ok) showToast('é…ç½®å·²æŒä¹…åŒ–');
                        else showToast('ä¿å­˜å¤±è´¥', 'error');
                    } catch (e) { showToast('ç½‘ç»œé”™è¯¯', 'error'); }
                };

                const selectRule = (rule) => {
                    currentRule.value = rule;
                    editorMode.value = 'rule';
                };

                const selectTraffic = (log) => {
                    selectedLog.value = log;
                    editorMode.value = 'traffic';
                };

                const addRule = () => {
                    const newRule = {
                        id: 'rule-' + Date.now(),
                        enabled: true,
                        name: 'API Mock ç¤ºä¾‹',
                        url: 'http://example.com/api',
                        matchType: 'regex',
                        response: {
                            statusCode: 200,
                            headers: { 'Content-Type': 'application/json' },
                            body: '{"status": "ok"}'
                        }
                    };
                    config.value.rules.unshift(newRule);
                    selectRule(newRule);
                };

                const deleteRule = async (id) => {
                    if (confirm('ç¡®å®šåˆ é™¤æ­¤è§„åˆ™ï¼Ÿ')) {
                        config.value.rules = config.value.rules.filter(r => r.id !== id);
                        currentRule.value = null;
                        editorMode.value = 'none';
                        // Save the updated config to server
                        await saveAll();
                        showToast('å·²åˆ é™¤');
                    }
                };

                const createRuleFromTraffic = (log) => {
                    addRule();
                    currentRule.value.url = log.url;
                    currentRule.value.name = 'Mock: ' + (log.url.split('/').pop() || 'Untitled');
                    activeTab.value = 'rules';
                };

                const exportConfig = () => {
                    const data = JSON.stringify(config.value, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'config.json';
                    a.click();
                };

                const regenerateCA = async () => {
                    if (confirm('ç¡®å®šé‡æ–°ç”Ÿæˆ CA è¯ä¹¦å—ï¼Ÿè¿™ä¼šå¯¼è‡´æ‰€æœ‰å·²å®‰è£…æ—§è¯ä¹¦çš„è®¾å¤‡ä¿¡ä»»å¤±æ•ˆã€‚')) {
                        try {
                            await fetch('/api/ca/generate', { method: 'POST' });
                            showToast('CA è¯ä¹¦å·²é‡ç”Ÿæˆ');
                        } catch (e) { showToast('é‡ç”Ÿæˆå¤±è´¥', 'error'); }
                    }
                };

                const formatTime = (t) => new Date(t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                let timer;
                onMounted(() => {
                    // Restore sidebar width
                    const savedWidth = localStorage.getItem('sidebarWidth');
                    if (savedWidth) sidebarWidth.value = parseInt(savedWidth);

                    getConfig();
                    timer = setInterval(() => getTraffic(false, true), 2000);
                });

                onUnmounted(() => clearInterval(timer));

                return {
                    config, traffic, activeTab, ruleSearch, trafficSearch, currentRule, selectedLog, editorMode, toast,
                    filteredRules, filteredTraffic, addRule, deleteRule, selectRule, selectTraffic, saveAll,
                    exportConfig, createRuleFromTraffic, getTraffic, formatTime, sidebarWidth, startResizing,
                    regenerateCA, showHelp, serverInfo
                };
            }
        }).mount('#app');
    </script>
</body>

</html>